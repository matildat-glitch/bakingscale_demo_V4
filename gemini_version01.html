<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LCD 編輯工坊 – Prototype</title>
  <style>
    :root {
      --bg: #f3f4f6;
      --panel: #ffffff;
      --text: #334155;
      --muted: #64748b;
      --blue: #2563eb;
      --green: #16a34a;
      --indigo: #4f46e5;
      --teal: #14b8a6;
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans TC", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .page {
      min-height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .toolbar {
      width: 100%;
      max-width: 1200px;
      background: var(--panel);
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      box-shadow: var(--shadow);
      flex-wrap: wrap;
    }
    .toolbar h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    .segmented {
      display: flex;
      background: #f1f5f9;
      border-radius: 10px;
      padding: 4px;
      gap: 4px;
    }
    .segmented button {
      border: 0;
      background: transparent;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
    }
    .segmented button.active {
      background: #ffffff;
      color: var(--blue);
      box-shadow: 0 2px 6px rgba(30, 64, 175, 0.15);
    }
    .segmented button.active.green {
      color: #15803d;
      background: #dcfce7;
    }
    .upload-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #c7d2fe;
      background: #eef2ff;
      color: #4338ca;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .upload-btn:hover { background: #e0e7ff; }
    .layout {
      width: 100%;
      max-width: 1300px;
      display: flex;
      gap: 24px;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .workbench {
      position: relative;
      width: 600px;
      height: 800px;
      background: #e2e8f0;
      border-radius: 26px;
      border: 2px solid #cbd5f5;
      box-shadow: 0 20px 60px rgba(15,23,42,0.25);
      overflow: hidden;
      user-select: none;
    }
    .controls {
      width: 280px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card {
      background: var(--panel);
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .card h3 {
      margin: 0 0 10px 0;
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .range {
      width: 100%;
      accent-color: #ea580c;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace;
    }
    .small { font-size: 12px; }
    .tiny { font-size: 10px; }
    .btn {
      width: 100%;
      border: 0;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-indigo { background: var(--indigo); color: #fff; }
    .btn-indigo:hover { background: #4338ca; }
    .btn-ghost { background: #e2e8f0; color: #475569; }
    .btn-ghost:hover { background: #cbd5e1; }
    .notice {
      background: #eff6ff;
      border: 1px solid #dbeafe;
      color: #475569;
    }
    .textarea {
      width: 100%;
      height: 120px;
      resize: none;
      border: 0;
      outline: none;
      background: transparent;
      color: #34d399;
      font-size: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace;
    }
    .codebox {
      background: #0f172a;
      border-radius: 8px;
      padding: 8px;
      position: relative;
    }
    .copy-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      border: 0;
      background: rgba(255,255,255,0.1);
      color: #fff;
      border-radius: 6px;
      padding: 4px 6px;
      font-size: 10px;
      cursor: pointer;
    }
    .scale-btn {
      position: absolute;
      border-radius: 999px;
      width: 48px;
      height: 48px;
      cursor: pointer;
    }
    .hotspot {
      background: rgba(239, 68, 68, 0.2);
      border: 2px dashed rgba(239, 68, 68, 0.7);
    }
    .hotspot.blue { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.8); }
    .hotspot.green { background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.8); }
    .hotspot.yellow { background: rgba(234, 179, 8, 0.2); border-color: rgba(234, 179, 8, 0.8); }

    .draggable {
      position: absolute;
      z-index: 50;
    }
    .draggable.editable { cursor: move; }
    .draggable.showbox { outline: 1px solid rgba(59,130,246,0.4); background: rgba(59,130,246,0.08); }
    .draggable.selected { outline: 2px solid rgba(59,130,246,1); background: rgba(59,130,246,0.12); }
    .label {
      position: absolute;
      top: -22px;
      left: 0;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 6px;
      background: #e2e8f0;
      color: #475569;
      white-space: nowrap;
      pointer-events: none;
    }
    .label.selected { background: #2563eb; color: #fff; }

    .lcd-bg-placeholder {
      border: 1px dashed rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    .ingre-tag {
      font-size: 10px;
      font-weight: 700;
      color: #0f766e;
      margin-right: 6px;
    }
    .bottom-line {
      height: 4px;
      background: var(--teal);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="page" id="app">
    <div class="toolbar">
      <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <h1>LCD 編輯工坊</h1>
        <div class="segmented">
          <button id="btnEdit" class="active">編輯位置</button>
          <button id="btnRun" class="">測試執行</button>
        </div>
      </div>
      <label class="upload-btn">
        上傳 LCD 底圖
        <input id="lcdUpload" type="file" accept="image/*" style="display:none" />
      </label>
    </div>

    <div class="layout">
      <div class="workbench" id="workbench">
        <div id="scaleLayer" style="position:absolute;"></div>
        <div id="lcdBgLayer" style="position:absolute; z-index:0;"></div>

        <div id="draggable-item" class="draggable"></div>
        <div id="draggable-lcdRight" class="draggable"></div>
        <div id="draggable-lcdLeftVal" class="draggable"></div>
        <div id="draggable-lcdLeftSeq" class="draggable"></div>
        <div id="draggable-tareIcons" class="draggable"></div>
        <div id="draggable-liveunit_g" class="draggable"></div>

        <div id="btnPowerUnit" class="scale-btn"></div>
        <div id="btnAddTare" class="scale-btn"></div>
        <div id="btnUp" class="scale-btn"></div>
        <div id="btnDown" class="scale-btn"></div>
      </div>

      <div class="controls">
        <div class="card">
          <h3>重量模擬</h3>
          <input id="weightRange" class="range" type="range" min="0" max="5000" step="1" value="0" />
          <div style="display:flex; justify-content:space-between;" class="mono small">
            <span id="weightValue">0g</span>
            <span id="tareValue">淨重</span>
          </div>
        </div>

        <div id="scaleControl" class="card" style="display:none; background:#eef2ff; border-color:#c7d2fe;">
          <h3 class="tiny" style="color:#3730a3;">調整選取物件: <span id="selectedLabel"></span></h3>
          <label class="tiny" style="color:#6366f1; display:block; margin-bottom:4px;">縮放比例: <span id="scaleValue">1.00</span></label>
          <input id="scaleRange" class="range" type="range" min="0.1" max="10" step="0.1" value="1" />
          <div class="mono tiny" style="color:#818cf8; margin-top:6px;">
            X: <span id="posX">0</span><br />
            Y: <span id="posY">0</span>
          </div>
        </div>

        <div class="card notice">
          <button id="exportBtn" class="btn btn-indigo">輸出位置設定</button>
          <div id="exportBox" style="display:none;" class="codebox">
            <textarea id="exportText" class="textarea" readonly></textarea>
            <button id="copyBtn" class="copy-btn">Copy</button>
          </div>
          <div class="small" style="margin-top:8px; color:#1e40af; font-weight:700;">操作說明 (V3)：</div>
          <ul class="small" style="margin:6px 0 10px 16px; padding:0;">
            <li><strong>TARE (右上)</strong>: 短按 = 記錄食材 (Add)，長按 1.5s = 歸零 (Stage Tare)</li>
            <li><strong>POWER (右下)</strong>: 短按 = 切換單位，長按 2s = 開關機</li>
            <li><strong>UP (左上)</strong>: 瀏覽 / 長按刪除單筆</li>
            <li><strong>DOWN (左下)</strong>: 瀏覽 / 長按刪除全部</li>
          </ul>
          <button id="hotspotBtn" class="btn btn-ghost">顯示熱區</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      scale: 200, x: -10, y: -300, itemSize: 150,
      lcdBackground: { x: 166, y: 623, scale: 100 },
      buttons: {
        btnPowerUnit: { x: 454, y: 672 },
        btnAddTare: { x: 454, y: 612 },
        btnUp: { x: 94, y: 612 },
        btnDown: { x: 94, y: 671 },
      },
      displayElements: {
        lcdRight: { x: 230, y: 465, scale: 1 },
        lcdLeftVal: { x: 130, y: 480, scale: 1 },
        lcdLeftSeq: { x: 205, y: 435, scale: 1 },
        tareIcons: { x: 130, y: 430, scale: 1 },
        item: { x: 223, y: 230, scale: 1 },
        liveunit_g: { x: 280, y: 500, scale: 1 },
      }
    };

    const state = {
      isEditMode: true,
      showHotspots: false,
      selectedId: null,
      lcdImage: null,
      displayPositions: {},
      isOn: true,
      unit: 'g',
      rawWeightG: 0,
      tareOffsetG: 0,
      tareStage: 0,
      seqInStage: 0,
      records: [],
      viewIndex: -1,
      ingreEnabled: true,
      deleteMode: false,
      deleteAllMode: false,
      deleteChoiceYes: true,
    };

    const lcdColors = { text: '#ffffff', ghost: 'rgba(255, 255, 255, 0.1)' };

    const clamp0 = (n) => Math.max(0, n);

    const initPositions = () => {
      Object.keys(CONFIG.displayElements).forEach(key => {
        const cfg = CONFIG.displayElements[key];
        state.displayPositions[key] = {
          x: CONFIG.x + cfg.x,
          y: CONFIG.y + cfg.y,
          scale: cfg.scale,
        };
      });
    };

    const svgScalePanel = `<!-- CustomScalePanel SVG -->
      <svg viewBox="0 0 449 570.24" class="w-full h-full" style="width:100%; height:100%; filter: drop-shadow(0 18px 40px rgba(0,0,0,0.4));">
        <defs>
          <style>
            .cls-1{mask:url(#mask)}.cls-2{filter:url(#luminosity-noclip)}.cls-3{fill:url(#_未命名的渐变_4)}.cls-4,.cls-5{fill:#34e6bf}.cls-5,.cls-6{font-family:Roboto-Bold,Roboto;font-size:5px;font-weight:700}.cls-6{fill:#fefefe}.cls-7{filter:url(#luminosity-noclip-2)}.cls-8{fill:#231f20}.cls-9{filter:url(#drop-shadow-1)}.cls-9,.cls-10{fill:#333132}.cls-11{fill:url(#_未命名的渐变_4-2)}.cls-12{fill:url(#_未命名的渐变_4-3)}.cls-13{fill:url(#_未命名的渐变_4-4)}.cls-14{fill:url(#_未命名的渐变_4-5)}.cls-15{fill:url(#_未命名的渐变_4-6)}.cls-16{fill:url(#linear-gradient)}.cls-17{isolation:isolate}.cls-18{mask:url(#mask-1)}.cls-19{letter-spacing:0em}.cls-20{fill:#fff}.cls-21{letter-spacing:0em}.cls-22{letter-spacing:-.06em}.cls-23{letter-spacing:-.03em}.cls-24{fill:#0e0e0e}.cls-25{mix-blend-mode:screen;opacity:.3}.cls-26{letter-spacing:0em}
          </style>
          <filter id="drop-shadow-1" x="0" y="0" width="449" height="457" filterUnits="userSpaceOnUse">
            <feOffset dx="0" dy="3.47"/>
            <feGaussianBlur result="blur" stdDeviation="7.02"/>
            <feFlood flood-color="#000" flood-opacity=".3"/>
            <feComposite in2="blur" operator="in"/>
            <feComposite in="SourceGraphic"/>
          </filter>
          <linearGradient id="linear-gradient" x1="76.06" y1="374.06" x2="381.32" y2="65.72" gradientTransform="translate(-.57 448.63) rotate(-90)" gradientUnits="userSpaceOnUse">
            <stop offset=".06" stop-color="#414042"/>
            <stop offset=".16" stop-color="#464648"/>
            <stop offset=".31" stop-color="#57575a"/>
            <stop offset=".47" stop-color="#727476"/>
            <stop offset=".56" stop-color="#848689"/>
            <stop offset=".86" stop-color="#5f6062"/>
          </linearGradient>
          <filter id="luminosity-noclip" x="120.11" y="463.19" width="207.84" height="75.36" color-interpolation-filters="sRGB" filterUnits="userSpaceOnUse">
            <feFlood flood-color="#fff" result="bg"/>
            <feBlend in="SourceGraphic" in2="bg"/>
          </filter>
          <mask id="mask" x="120.11" y="463.19" width="207.84" height="75.36" maskUnits="userSpaceOnUse">
            <g class="cls-2">
              <rect x="120.11" y="463.19" width="207.84" height="75.36" fill="white" />
            </g>
          </mask>
          <filter id="luminosity-noclip-2" x="120.11" y="463.19" width="207.84" height="75.36" color-interpolation-filters="sRGB" filterUnits="userSpaceOnUse">
            <feFlood flood-color="#fff" result="bg"/>
            <feBlend in="SourceGraphic" in2="bg"/>
          </filter>
          <mask id="mask-1" x="120.11" y="463.19" width="207.84" height="75.36" maskUnits="userSpaceOnUse">
            <g class="cls-7">
              <rect x="120.11" y="463.19" width="207.84" height="75.36" fill="white" />
            </g>
          </mask>
          <radialGradient id="_未命名的渐变_4" data-name="未命名的渐变 4" cx="357.75" cy="478.11" fx="388.29" fy="470.82" r="42.05" gradientUnits="userSpaceOnUse">
            <stop offset=".03" stop-color="#333"/>
            <stop offset="1" stop-color="#0a0a0a"/>
          </radialGradient>
          <radialGradient id="_未命名的渐变_4-2" data-name="未命名的渐变 4" cy="523.44" fx="388.29" fy="516.15" r="42.05" href="#_未命名的渐变_4"/>
          <radialGradient id="_未命名的渐变_4-3" data-name="未命名的渐变 4" cy="521.44" fx="388.29" fy="514.15" r="42.05" href="#_未命名的渐变_4"/>
          <radialGradient id="_未命名的渐变_4-4" data-name="未命名的渐变 4" cy="476.11" fy="468.82" href="#_未命名的渐变_4"/>
          <radialGradient id="_未命名的渐变_4-5" data-name="未命名的渐变 4" cx="88.55" cy="475.84" fx="119.1" fy="468.55" r="42.05" href="#_未命名的渐变_4"/>
          <radialGradient id="_未命名的渐变_4-6" data-name="未命名的渐变 4" cx="88.55" cy="520.7" fx="119.1" fy="513.41" r="42.05" href="#_未命名的渐变_4"/>
        </defs>
        <g class="cls-17">
          <g id="Layer_2" data-name="Layer 2">
            <g id="Layer_1-2" data-name="Layer 1">
              <g>
                <rect class="cls-10" x="21.52" y="17.94" width="405.02" height="552.3" rx="63.37" ry="63.37"/>
                <rect class="cls-9" x="21.52" y="17.94" width="405.02" height="413.32" rx="63.37" ry="63.37"/>
                <rect class="cls-16" x="24.21" y="28.93" width="399.63" height="391.34" rx="56.52" ry="56.52" transform="translate(448.63 .57) rotate(90)"/>
              </g>
              <g>
                <g>
                  <rect class="cls-8" x="37.91" y="443.36" width="372.24" height="112.8" rx="56.4" ry="56.4"/>
                  <g>
                    <path class="cls-20" d="M227.73,454.96c.49,0,.95.16,1.3.48.04.04.11.04.15,0l.37-.37s.04-.11,0-.15c-.56-.51-1.3-.76-2.07-.68-1.21.13-2.19,1.1-2.33,2.31-.19,1.65,1.15,3.04,2.78,2.94.58-.03,1.13-.27,1.57-.65h0c.06-.05.09-.12.09-.19v-1.91c0-.06-.05-.11-.11-.11h-1.79c-.06,0-.11.05-.11.11v.53c0,.06.05.11.11.11h1.05c.06,0,.11.05.11.11v.8c0,.09-.05.17-.12.21-.29.17-.62.26-.96.26-1.08,0-1.95-.91-1.89-2,.05-.98.87-1.78,1.86-1.8Z"/>
                    <path class="cls-20" d="M229.87,449.48l-.51-.15c-.05-.02-.11.02-.13.07-.58,1.72-2.97,2.37-4.74,2.84l-.29.08s-.08-.03-.07-.07c.14-.55.68-2.61.82-3.12.02-.05-.01-.11-.07-.13l-.5-.17c-.06-.02-.12.01-.13.07,0,.02,0,.03-.01.05-.01.03-.05.04-.08.01-.1-.14-.23-.26-.37-.36-.98-.68-2.52-.16-3.45,1.16-.93,1.32-.88,2.95.09,3.64.08.05.18.11.31.17.04.02.05.08,0,.1-.61.39-1.15.84-1.6,1.36-.58.66-1.14,1.84-1.02,2.88.07.56.34,1.06.75,1.36.34.25.73.36,1.12.36.65,0,1.31-.29,1.81-.69,1.31-1.05,1.5-2.28,1.69-3.47.02-.1.39-2.17.39-2.17.02-.08.08-.15.16-.17.2-.06.41-.11.62-.17,1.93-.52,4.57-1.22,5.25-3.34.02-.06-.02-.12-.07-.13ZM222.78,455.36c-.18,1.15-.34,2.15-1.43,3.01-.57.45-1.45.75-2.03.31-.24-.18-.41-.45-.85-.08-.69.27-1.66.84-2.31.52-.59,1.17-1.1,1.93-1.51.44-.24.91-.4,1.4-.56.04-.01.08.02.07.06-.1.52-.31,1.74-.32,1.84ZM223.33,452.46c-.02.08-.08.14-.15.16-.21.07-.61.2-.63.2-1.02.34-1.52.09-1.69-.03-.63-.44-.59-1.63.09-2.61.68-.97,1.79-1.42,2.42-.98.38.27.53.82.41,1.47-.16.63-.33,1.29-.44,1.77Z"/>
                  </g>
                </g>
                <g>
                  <rect class="cls-24" x="122.27" y="465.38" width="203.52" height="71.02" rx="3.52" ry="3.52"/>
                  <g class="cls-1">
                    <g class="cls-25">
                      <rect x="122.27" y="465.38" width="203.52" height="71.02" rx="3.52" ry="3.52"/>
                    </g>
                  </g>
                </g>
                <g>
                  <path class="cls-24" d="M323.06,465.38H125c-1.51,0-2.73,1.22-2.73,2.73v65.56c0,1.51,1.22,2.73,2.73,2.73h198.06c1.51,0,2.73-1.22,2.73-2.73v-65.56c0-1.51-1.22-2.73-2.73-2.73ZM322.37,530.26c0,1.5-1.23,2.73-2.73,2.73h-191.23c-1.51,0-2.73-1.22-2.73-2.73v-58.73c0-1.5,1.23-2.73,2.73-2.73h191.23c1.5,0,2.73,1.23,2.73,2.73v58.73Z"/>
                  <g class="cls-18">
                    <g class="cls-25">
                      <path d="M323.06,465.38H125c-1.51,0-2.73,1.22-2.73,2.73v65.56c0,1.51,1.22,2.73,2.73,2.73h198.06c1.51,0,2.73-1.22,2.73-2.73v-65.56c0-1.51-1.22-2.73-2.73-2.73ZM322.37,530.26c0,1.5-1.23,2.73-2.73,2.73h-191.23c-1.51,0-2.73-1.22-2.73-2.73v-58.73c0-1.5,1.23-2.73,2.73-2.73h191.23c1.5,0,2.73,1.23,2.73,2.73v58.73Z"/>
                    </g>
                  </g>
                </g>
                <circle class="cls-3" cx="357.65" cy="478.11" r="17.76"/>
                <circle class="cls-11" cx="357.65" cy="523.44" r="17.76"/>
                <g>
                  <circle class="cls-12" cx="357.65" cy="521.44" r="17.76"/>
                  <text class="cls-6" transform="translate(349.13 545.15)"><tspan x="0" y="0">POWER</tspan></text>
                  <path class="cls-20" d="M357.7,527.25h-.1c-3.18,0-5.77-2.59-5.77-5.77v-4.95c0-.51.41-.92.92-.92s.92.41.92.92v4.95c0,2.17,1.76,3.93,3.93,3.93h.1c2.17,0,3.93-1.76,3.93-3.93v-4.95c0-.51.41-.92.92-.92s.92.41.92.92v4.95c0,3.18-2.59,5.77-5.77,5.77Z"/>
                </g>
                <g>
                  <circle class="cls-13" cx="357.65" cy="476.11" r="17.76"/>
                  <text class="cls-6" transform="translate(351.57 499.9)"><tspan class="cls-22" x="0" y="0">T</tspan><tspan class="cls-19" x="2.8" y="0">ARE</tspan></text>
                  <path class="cls-4" d="M362.53,475.11h-3.88v-3.88c0-.55-.45-1-1-1s-1,.45-1,1v3.88h-3.88c-.55,0-1,.45-1,1s.45,1,1,1h3.88v3.88c0,.55.45,1,1,1s1-.45,1-1v-3.88h3.88c.55,0,1-.45,1-1s-.45-1-1-1Z"/>
                </g>
                <g>
                  <circle class="cls-14" cx="88.46" cy="475.84" r="17.76"/>
                  <path class="cls-4" d="M93.41,477.88h-9.9c-.35,0-.52-.42-.27-.66l5.22-5.09,5.22,5.09c.25.24.08.66-.27.66Z"/>
                  <text class="cls-5" transform="translate(81.5 499.62)"><tspan x="0" y="0">MODE</tspan></text>
                </g>
                <g>
                  <circle class="cls-15" cx="88.46" cy="520.7" r="17.76"/>
                  <path class="cls-4" d="M83.51,518.95h9.9c.35,0,.52.42.27.66l-5.22,5.09-5.22-5.09c-.25-.24-.08-.66.27-.66Z"/>
                  <text class="cls-5" transform="translate(80.94 544.33)"><tspan x="0" y="0">RES</tspan><tspan class="cls-26" x="9.07" y="0">E</tspan><tspan class="cls-23" x="11.93" y="0">T</tspan></text>
                </g>
              </g>
            </g>
          </g>
        </g>
      </svg>`;

    const liveUnitGSVG = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3.51 5.43" style="width:100%; height:100%; display:block">
        <path d="M0 1.96C0 1.37.14.9.42.54S1.08 0 1.55 0c.42 0 .75.14.98.43l.04-.36h.93v3.72c0 .34-.08.63-.23.88-.15.25-.37.44-.64.57a2.27 2.27 0 0 1-1.79.03c-.26-.11-.47-.26-.61-.44l.45-.62c.26.29.57.43.93.43.27 0 .48-.07.64-.22.15-.15.23-.35.23-.62v-.21c-.24.27-.55.4-.93.4-.46 0-.84-.18-1.12-.54S0 2.61 0 2.01v-.04Zm1.03.08c0 .35.07.62.21.82s.33.3.58.3c.31 0 .54-.12.67-.35V1.19C2.35.95 2.13.84 1.83.84c-.25 0-.44.1-.58.3-.14.2-.21.5-.21.9Z" fill="#fefefe"/>
      </svg>`;

    const segments = {
      0: ['a', 'b', 'c', 'd', 'e', 'f'],
      1: ['b', 'c'],
      2: ['a', 'b', 'd', 'e', 'g'],
      3: ['a', 'b', 'c', 'd', 'g'],
      4: ['b', 'c', 'f', 'g'],
      5: ['a', 'c', 'd', 'f', 'g'],
      6: ['a', 'c', 'd', 'e', 'f', 'g'],
      7: ['a', 'b', 'c'],
      8: ['a', 'b', 'c', 'd', 'e', 'f', 'g'],
      9: ['a', 'b', 'c', 'd', 'f', 'g'],
      'Y': ['b', 'c', 'd', 'f', 'g'],
      'E': ['a', 'd', 'e', 'f', 'g'],
      'S': ['a', 'c', 'd', 'f', 'g'],
      'N': ['c', 'e', 'g'],
      'O': ['c', 'd', 'e', 'g'],
      't': ['d', 'e', 'f', 'g'],
      '-': ['g'],
      ':': [],
      '.': [],
      ' ': []
    };

    const paths = {
      a: "M54.84,3.22l-9.48,9.48H13.9L4.42,3.22C6.68,1.22,9.67,0,12.91,0h33.44c3.25,0,6.23,1.22,8.49,3.22Z",
      b: "M59.27,12.91v64.2l-1.2,1.2-5.15,5.15-6.35-6.35V13.9l9.48-9.48c2,2.26,3.22,5.24,3.22,8.49Z",
      c: "M59.27,92.22v64.2c0,3.25-1.22,6.23-3.22,8.49l-9.48-9.48v-63.22l6.35-6.35,5.15,5.15,1.2,1.2Z",
      d: "M54.84,166.11c-2.26,2-5.24,3.22-8.49,3.22H12.91c-3.25,0-6.23-1.22-8.49-3.22l9.48-9.48h31.47l9.48,9.48Z",
      e: "M12.7,92.22v63.22l-9.48,9.48c-2-2.26-3.22-5.24-3.22-8.49v-64.23l1.18-1.18,5.17-5.15,6.35,6.35Z",
      f: "M12.7,13.9v63.22l-6.35,6.35-5.17-5.15-1.18-1.18V12.91c0-3.25,1.22-6.23,3.22-8.49l9.48,9.48Z",
      g: "M51.72,84.67 L46.57,89.82 L45.37,91.02 L13.9,91.02 L12.7,89.82 L7.55,84.67 L13.9,78.32 L45.37,78.32 Z"
    };

    const createSevenSegmentDigit = (char, size, colorOn, colorOff) => {
      if (char === ':') {
        return `<svg width="${size/2}" height="${size*2.85}" viewBox="0 0 30 170" style="margin:0 2px; display:block;">
          <circle cx="15" cy="50" r="8" fill="${colorOn}" />
          <circle cx="15" cy="120" r="8" fill="${colorOn}" />
        </svg>`;
      }
      if (char === '.') {
        return `<svg width="${size/3}" height="${size*2.85}" viewBox="0 0 20 170" style="margin:0 1px; display:block;">
          <circle cx="10" cy="155" r="8" fill="${colorOn}" />
        </svg>`;
      }
      const active = segments[char] || [];
      const segPaths = Object.keys(paths).map((key) => {
        const fill = active.includes(key) ? colorOn : colorOff;
        return `<path d="${paths[key]}" fill="${fill}" stroke="none"></path>`;
      }).join('');
      return `<svg width="${size}" height="${size*2.85}" viewBox="0 0 59.27 169.33" style="display:block; margin:0 1px;">
        <g>${segPaths}</g>
      </svg>`;
    };

    const createSevenSegmentString = (text, size, colorOn, colorOff) => {
      const chars = String(text).split('');
      return `<div style="display:flex; align-items:flex-end; justify-content:flex-end; pointer-events:none;">${chars.map(c => createSevenSegmentDigit(c, size, colorOn, colorOff)).join('')}</div>`;
    };

    const renderScalePanel = () => {
      const layer = document.getElementById('scaleLayer');
      layer.style.top = CONFIG.y + 'px';
      layer.style.left = CONFIG.x + 'px';
      layer.innerHTML = `<div style="width:${CONFIG.scale}%; max-width:none;">${svgScalePanel}</div>`;
    };

    const renderLcdBackground = () => {
      const layer = document.getElementById('lcdBgLayer');
      layer.style.top = (CONFIG.y + CONFIG.lcdBackground.y) + 'px';
      layer.style.left = (CONFIG.x + CONFIG.lcdBackground.x) + 'px';
      const width = 203.52 * (CONFIG.scale/100) * (CONFIG.lcdBackground.scale/100);
      const content = state.lcdImage
        ? `<img src="${state.lcdImage}" alt="LCD Background" style="width:100%; height:auto; display:block;" draggable="false" />`
        : `<div class="lcd-bg-placeholder" style="width:100%; height:100%;">LCD BG Area</div>`;
      layer.innerHTML = `<div style="width:${width}px; opacity:0.5;">${content}</div>`;
    };

    const latestIndex = () => state.records.length - 1;
    const getNetWeightG = () => clamp0(state.rawWeightG - state.tareOffsetG);

    const formatValueByUnit = (valG, u) => {
      if (u === 'g' || u === 'ml') return Math.round(valG).toString();
      if (u === 'oz' || u === 'fl.oz') return (valG * 0.035274).toFixed(2);
      if (u === 'lb') return (valG * 0.00220462).toFixed(3);
      if (u === 'lb oz') {
        const totalOz = valG * 0.035274;
        const lb = Math.floor(totalOz / 16);
        const oz = totalOz - lb * 16;
        return `${lb}:${oz.toFixed(1)}`;
      }
      return Math.round(valG).toString();
    };

    const renumberRecords = (records) => {
      let stage = 0;
      let seq = 0;
      const newRecs = records.map(rec => {
        if (rec.type === 'tare') {
          if (stage < 5) { stage++; seq = 0; }
          return { ...rec, stage };
        }
        seq++;
        return { ...rec, stage, seq };
      });
      state.tareStage = stage;
      state.seqInStage = seq;
      return newRecs;
    };

    const handleUnit = () => {
      if (!state.isOn) return;
      if (state.deleteMode || state.deleteAllMode) return;
      const units = ['g', 'lb oz', 'lb', 'oz', 'fl.oz', 'ml'];
      const idx = units.indexOf(state.unit);
      state.unit = units[(idx + 1) % units.length];
      render();
    };

    const handlePower = () => {
      state.isOn = !state.isOn;
      if (state.isOn) {
        state.rawWeightG = 0;
        state.tareOffsetG = 0;
        state.unit = 'g';
        state.ingreEnabled = true;
      } else {
        state.records = [];
        state.viewIndex = -1;
        state.tareStage = 0;
        state.seqInStage = 0;
        state.deleteMode = false;
        state.deleteAllMode = false;
      }
      render();
    };

    const handleSaveWeight = () => {
      if (!state.isOn) return;
      if (state.deleteMode || state.deleteAllMode) {
        if (state.deleteChoiceYes) {
          if (state.deleteAllMode) {
            state.records = [];
            state.viewIndex = -1;
            state.tareStage = 0;
            state.seqInStage = 0;
          } else {
            const newRecs = [...state.records];
            newRecs.splice(state.viewIndex, 1);
            if (newRecs.length === 0) {
              state.records = [];
              state.viewIndex = -1;
            } else {
              const renum = renumberRecords(newRecs);
              state.records = renum;
              state.viewIndex = Math.min(state.viewIndex, renum.length - 1);
            }
          }
        }
        state.deleteMode = false;
        state.deleteAllMode = false;
        render();
        return;
      }

      if (!state.ingreEnabled) return;
      const net = getNetWeightG();
      if (net <= 0) return;

      const newSeq = state.seqInStage + 1;
      state.seqInStage = newSeq;
      const newRec = { type: 'weight', stage: state.tareStage, seq: newSeq, weightG: net, unit: state.unit };
      state.records = [...state.records, newRec];
      state.viewIndex = state.records.length - 1;
      state.tareOffsetG = state.rawWeightG;
      render();
    };

    const handleTare = () => {
      if (!state.isOn) return;
      if (state.deleteMode || state.deleteAllMode) return;
      const net = getNetWeightG();
      if (net <= 0) return;

      if (state.ingreEnabled && state.tareStage < 5) {
        const newStage = state.tareStage + 1;
        state.tareStage = newStage;
        state.seqInStage = 0;
        const newRec = { type: 'tare', stage: newStage };
        state.records = [...state.records, newRec];
        state.viewIndex = state.records.length - 1;
      }
      state.tareOffsetG = state.rawWeightG;
      render();
    };

    const handleBrowsePrev = () => {
      if (!state.isOn) return;
      if (state.deleteMode || state.deleteAllMode) {
        state.deleteChoiceYes = !state.deleteChoiceYes;
        render();
        return;
      }
      if (state.records.length === 0) return;
      state.viewIndex = Math.max(0, state.viewIndex - 1);
      render();
    };

    const handleBrowseNext = () => {
      if (!state.isOn) return;
      if (state.deleteMode || state.deleteAllMode) {
        state.deleteChoiceYes = !state.deleteChoiceYes;
        render();
        return;
      }
      if (state.records.length === 0) return;
      state.viewIndex = Math.min(latestIndex(), state.viewIndex + 1);
      render();
    };

    const handleToggleIngre = () => {
      if (!state.isOn) return;
      state.ingreEnabled = !state.ingreEnabled;
      render();
    };

    const handleClearAll = () => {
      if (!state.isOn) return;
      if (state.records.length > 0) {
        state.deleteAllMode = true;
        state.deleteChoiceYes = true;
        render();
      }
    };

    const handleDeleteSingle = () => {
      if (!state.isOn) return;
      if (state.records.length > 0 && state.viewIndex >= 0) {
        state.deleteMode = true;
        state.deleteChoiceYes = true;
        render();
      }
    };

    const setSelected = (id) => {
      if (!state.isEditMode) return;
      state.selectedId = id;
      render();
    };

    const updateDisplayPos = (id, newPos) => {
      state.displayPositions[id] = { ...state.displayPositions[id], ...newPos };
      updateSelectedInfo();
    };

    const updateDisplayScale = (id, scale) => {
      state.displayPositions[id] = { ...state.displayPositions[id], scale };
      render();
    };

    const applyDragBehavior = (id) => {
      const el = document.getElementById(`draggable-${id}`);
      let dragging = false;
      let offset = { x: 0, y: 0 };

      el.addEventListener('mousedown', (e) => {
        if (!state.isEditMode) return;
        setSelected(id);
        dragging = true;
        const rect = el.getBoundingClientRect();
        offset = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        e.preventDefault();
        e.stopPropagation();
      });

      window.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        const parent = document.getElementById('workbench');
        const rect = parent.getBoundingClientRect();
        const newX = e.clientX - rect.left - offset.x;
        const newY = e.clientY - rect.top - offset.y;
        updateDisplayPos(id, { x: newX, y: newY });
      });

      window.addEventListener('mouseup', () => { dragging = false; });
    };

    const renderDraggable = (id, content, options = {}) => {
      const el = document.getElementById(`draggable-${id}`);
      const pos = state.displayPositions[id];
      const isSelected = state.selectedId === id;
      const isVisible = state.isEditMode || state.showHotspots;
      el.style.left = pos.x + 'px';
      el.style.top = pos.y + 'px';
      el.style.transform = `scale(${pos.scale || 1})`;
      el.style.transformOrigin = 'top left';
      el.className = `draggable ${state.isEditMode ? 'editable' : ''} ${isVisible ? 'showbox' : ''} ${isSelected ? 'selected' : ''}`;
      const label = options.label ? `<div class="label ${isSelected ? 'selected' : ''}">${options.label}</div>` : '';
      el.innerHTML = `${isVisible && options.label ? label : ''}${content}`;
    };

    const updateSelectedInfo = () => {
      const panel = document.getElementById('scaleControl');
      if (!state.isEditMode || !state.selectedId) {
        panel.style.display = 'none';
        return;
      }
      const pos = state.displayPositions[state.selectedId];
      document.getElementById('selectedLabel').textContent = state.selectedId;
      document.getElementById('scaleValue').textContent = pos.scale.toFixed(2);
      document.getElementById('scaleRange').value = pos.scale;
      document.getElementById('posX').textContent = Math.round(pos.x - CONFIG.x);
      document.getElementById('posY').textContent = Math.round(pos.y - CONFIG.y);
      panel.style.display = 'block';
    };

    const render = () => {
      renderScalePanel();
      renderLcdBackground();

      const currentRec = (state.viewIndex >= 0 && state.viewIndex < state.records.length) ? state.records[state.viewIndex] : null;
      const isTareRec = currentRec && currentRec.type === 'tare';

      let rightDisplayStr = "";
      if (!state.isOn) rightDisplayStr = "";
      else if (state.deleteMode || state.deleteAllMode) rightDisplayStr = state.deleteChoiceYes ? "YES" : "NO";
      else rightDisplayStr = formatValueByUnit(getNetWeightG(), state.unit);

      let leftValStr = "";
      let leftSeqStr = "";
      let showBottomLine = false;

      if (state.isOn && currentRec) {
        if (isTareRec) {
          leftSeqStr = "00";
          leftValStr = "t";
        } else {
          leftSeqStr = String(currentRec.seq).padStart(2, '0');
          leftValStr = formatValueByUnit(currentRec.weightG, currentRec.unit);
        }
        if (state.viewIndex === state.records.length - 1) showBottomLine = true;
      }

      const itemVisible = !state.isEditMode && !state.showHotspots && state.rawWeightG > 0;
      const itemSize = Math.min(CONFIG.itemSize, (CONFIG.itemSize * 0.3) + (state.rawWeightG / 5000 * CONFIG.itemSize * 0.7));
      const itemOffset = (CONFIG.itemSize - itemSize) / 2;

      renderDraggable('item', `
        <div style="position:absolute; top:0; left:0; width:${itemSize}px; height:${itemSize}px; transform: translate(${itemOffset}px, ${itemOffset}px); border-radius:999px; background:#fed7aa; border:4px solid #fdba74; box-shadow:0 10px 20px rgba(120,53,15,0.2); display:${itemVisible ? 'flex' : 'none'}; align-items:center; justify-content:center;">
          <span class="tiny" style="color:#9a3412; font-weight:700;">Item</span>
        </div>
      `, { label: 'Item' });

      renderDraggable('lcdRight', `
        <div style="padding:4px 8px; border-radius:6px;">
          ${createSevenSegmentString(rightDisplayStr, 32, lcdColors.text, (state.isEditMode || state.showHotspots) ? lcdColors.ghost : 'transparent')}
        </div>
      `, { label: '主螢幕 (右)' });

      renderDraggable('lcdLeftVal', `
        <div style="padding:4px 6px; border-radius:6px;">
          ${createSevenSegmentString(leftValStr, 20, lcdColors.text, (state.isEditMode || state.showHotspots) ? lcdColors.ghost : 'transparent')}
          ${showBottomLine ? '<div class="bottom-line"></div>' : ''}
        </div>
      `, { label: '紀錄值 (左)' });

      renderDraggable('lcdLeftSeq', `
        <div style="padding:2px 4px; border-radius:6px; display:flex; align-items:center; gap:6px;">
          ${(state.isOn && state.ingreEnabled) ? '<span class="ingre-tag">INGREDIENT</span>' : ''}
          ${createSevenSegmentString(leftSeqStr, 12, lcdColors.text, (state.showHotspots) ? lcdColors.ghost : 'transparent')}
        </div>
      `, { label: '序號 (左上)' });

      renderDraggable('tareIcons', `
        <div style="display:flex; gap:4px; padding:4px; border-radius:6px;">
          ${[1,2,3,4,5].map(i => `<div style="width:8px; height:8px; border-radius:999px; border:1px solid #475569; background:${state.isOn && i <= state.tareStage ? '#0f172a' : 'transparent'}"></div>`).join('')}
        </div>
      `, { label: '階段燈號' });

      const gVisible = (state.isOn && state.unit === 'g') || state.isEditMode;
      renderDraggable('liveunit_g', `
        <div style="width:20px; display:${gVisible ? 'block' : 'none'}; opacity:${(state.isOn && state.unit === 'g') ? 1 : 0.3};">
          ${liveUnitGSVG}
        </div>
      `, { label: 'Unit G' });

      document.getElementById('weightValue').textContent = `${state.rawWeightG}g`;
      document.getElementById('tareValue').textContent = state.tareOffsetG > 0 ? `扣重:${state.tareOffsetG}` : '淨重';
      document.getElementById('tareValue').style.color = state.tareOffsetG > 0 ? '#ef4444' : '#64748b';

      updateSelectedInfo();
      renderButtons();
      updateToolbarButtons();
    };

    const updateToolbarButtons = () => {
      const btnEdit = document.getElementById('btnEdit');
      const btnRun = document.getElementById('btnRun');
      btnEdit.classList.toggle('active', state.isEditMode);
      btnRun.classList.toggle('active', !state.isEditMode);
      btnRun.classList.toggle('green', !state.isEditMode);
    };

    const renderButtons = () => {
      const placeBtn = (id, colorClass) => {
        const btn = document.getElementById(id);
        const pos = CONFIG.buttons[id];
        btn.style.left = (CONFIG.x + pos.x) + 'px';
        btn.style.top = (CONFIG.y + pos.y) + 'px';
        btn.className = `scale-btn ${state.showHotspots ? 'hotspot ' + colorClass : ''}`;
      };
      placeBtn('btnPowerUnit', '');
      placeBtn('btnAddTare', 'blue');
      placeBtn('btnUp', 'green');
      placeBtn('btnDown', 'yellow');
    };

    const handleExport = () => {
      const relative = {};
      Object.keys(state.displayPositions).forEach(key => {
        relative[key] = {
          x: Math.round(state.displayPositions[key].x - CONFIG.x),
          y: Math.round(state.displayPositions[key].y - CONFIG.y),
          scale: Number(state.displayPositions[key].scale.toFixed(2))
        };
      });
      const exportStr = `\n// 複製此區塊到 CONFIG.displayElements\ndisplayElements: ${JSON.stringify(relative, null, 4).replace(/"/g, '')}\n`;
      document.getElementById('exportText').value = exportStr;
      document.getElementById('exportBox').style.display = 'block';
    };

    const setupLongPress = (el, onShortPress, onLongPress, longPressMs) => {
      let timer = null;
      let isLong = false;
      el.addEventListener('mousedown', (e) => {
        isLong = false;
        timer = setTimeout(() => {
          isLong = true;
          if (onLongPress) onLongPress(e);
        }, longPressMs);
      });
      el.addEventListener('mouseup', (e) => {
        if (timer) clearTimeout(timer);
        if (!isLong && onShortPress) onShortPress(e);
      });
      el.addEventListener('mouseleave', () => { if (timer) clearTimeout(timer); });
      el.addEventListener('contextmenu', (e) => e.preventDefault());
    };

    const bindEvents = () => {
      document.getElementById('btnEdit').addEventListener('click', (e) => {
        e.stopPropagation();
        state.isEditMode = true;
        state.selectedId = null;
        render();
      });
      document.getElementById('btnRun').addEventListener('click', (e) => {
        e.stopPropagation();
        state.isEditMode = false;
        state.selectedId = null;
        render();
      });

      document.getElementById('workbench').addEventListener('click', () => {
        if (state.isEditMode) { state.selectedId = null; render(); }
      });

      document.getElementById('weightRange').addEventListener('input', (e) => {
        state.rawWeightG = Number(e.target.value);
        render();
      });

      document.getElementById('scaleRange').addEventListener('input', (e) => {
        if (!state.selectedId) return;
        updateDisplayScale(state.selectedId, Number(e.target.value));
      });

      document.getElementById('exportBtn').addEventListener('click', handleExport);
      document.getElementById('copyBtn').addEventListener('click', () => {
        const text = document.getElementById('exportText').value;
        navigator.clipboard.writeText(text);
      });

      document.getElementById('hotspotBtn').addEventListener('click', () => {
        state.showHotspots = !state.showHotspots;
        document.getElementById('hotspotBtn').textContent = state.showHotspots ? '隱藏熱區' : '顯示熱區';
        render();
      });

      document.getElementById('lcdUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          state.lcdImage = ev.target.result;
          renderLcdBackground();
        };
        reader.readAsDataURL(file);
      });

      setupLongPress(document.getElementById('btnPowerUnit'), handleUnit, handlePower, 1500);
      setupLongPress(document.getElementById('btnAddTare'), handleSaveWeight, handleTare, 1500);
      setupLongPress(document.getElementById('btnUp'), handleBrowsePrev, handleToggleIngre, 1500);
      setupLongPress(document.getElementById('btnDown'), handleBrowseNext, handleClearAll, 1500);

      applyDragBehavior('item');
      applyDragBehavior('lcdRight');
      applyDragBehavior('lcdLeftVal');
      applyDragBehavior('lcdLeftSeq');
      applyDragBehavior('tareIcons');
      applyDragBehavior('liveunit_g');
    };

    initPositions();
    bindEvents();
    render();
  </script>
</body>
</html>
